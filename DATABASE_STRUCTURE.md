# Схема базы данных и описание структуры

## Содержание

1. [Введение](#введение)
2. [Модель данных](#модель-данных)
3. [Описание таблиц](#описание-таблиц)
4. [Связи между таблицами](#связи-между-таблицами)
5. [Индексы и оптимизация](#индексы-и-оптимизация)
6. [Примеры запросов](#примеры-запросов)

## Введение

В данном документе представлено описание структуры базы данных школьного приложения. База данных построена на основе реляционной модели и управляется через SQLAlchemy ORM (Object-Relational Mapping), что обеспечивает удобный программный интерфейс для работы с данными из приложения на языке Python.

Школьное приложение использует SQLite в качестве СУБД по умолчанию, но архитектура позволяет при необходимости перейти на более мощные системы, такие как PostgreSQL или MySQL, без изменения кода приложения.

## Модель данных

Концептуально база данных представляет следующие основные сущности и их взаимосвязи:

```
+----------+     +--------+     +----------+
|   User   |-----|  Group |-----|  Subject |
+----------+     +--------+     +----------+
      |              |              |
      |              |              |
      v              v              v
+----------+     +----------+     +--------+
| Attendance|-----|  Schedule |---|  Grade  |
+----------+     +----------+     +--------+
```

## Описание таблиц

### Таблица `user`

Содержит информацию о пользователях системы всех типов (студенты, преподаватели, администраторы).

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | Integer | Уникальный идентификатор пользователя | Первичный ключ, автоинкремент |
| username | String(64) | Имя пользователя для входа в систему | Уникальное, не NULL |
| email | String(120) | Email адрес пользователя | Уникальный, не NULL |
| password_hash | String(128) | Хеш пароля пользователя | |
| first_name | String(64) | Имя пользователя | |
| last_name | String(64) | Фамилия пользователя | |
| role | String(20) | Роль пользователя в системе | Значения: 'student', 'teacher', 'admin' |

### Таблица `group`

Содержит информацию об учебных группах.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | Integer | Уникальный идентификатор группы | Первичный ключ, автоинкремент |
| name | String(64) | Название группы | Уникальное, не NULL |
| faculty | String(64) | Факультет или отделение | |
| year | Integer | Год обучения | |

### Таблица `subject`

Содержит информацию об учебных предметах.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | Integer | Уникальный идентификатор предмета | Первичный ключ, автоинкремент |
| name | String(64) | Название предмета | Не NULL |
| description | Text | Описание предмета | |
| teacher_id | Integer | Идентификатор преподавателя | Внешний ключ -> user.id |

### Таблица `schedule`

Содержит информацию о расписании занятий.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | Integer | Уникальный идентификатор занятия | Первичный ключ, автоинкремент |
| day_of_week | Integer | День недели (0-6) | Не NULL |
| start_time | Time | Время начала занятия | Не NULL |
| end_time | Time | Время окончания занятия | Не NULL |
| room | String(20) | Номер аудитории | |
| subject_id | Integer | Идентификатор предмета | Внешний ключ -> subject.id, не NULL |
| group_id | Integer | Идентификатор группы | Внешний ключ -> group.id, не NULL |

### Таблица `attendance`

Содержит информацию о посещаемости занятий студентами.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | Integer | Уникальный идентификатор записи | Первичный ключ, автоинкремент |
| date | Date | Дата занятия | Не NULL, по умолчанию текущая дата |
| status | Boolean | Статус присутствия | По умолчанию False (отсутствовал) |
| student_id | Integer | Идентификатор студента | Внешний ключ -> user.id, не NULL |
| schedule_id | Integer | Идентификатор занятия по расписанию | Внешний ключ -> schedule.id, не NULL |

### Таблица `grade`

Содержит информацию об оценках студентов.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| id | Integer | Уникальный идентификатор оценки | Первичный ключ, автоинкремент |
| value | Integer | Значение оценки | Не NULL |
| date | Date | Дата выставления оценки | Не NULL, по умолчанию текущая дата |
| comment | Text | Комментарий к оценке | |
| student_id | Integer | Идентификатор студента | Внешний ключ -> user.id, не NULL |
| subject_id | Integer | Идентификатор предмета | Внешний ключ -> subject.id, не NULL |

### Таблица `student_group`

Связующая таблица для отношения многие-ко-многим между студентами и группами.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| student_id | Integer | Идентификатор студента | Внешний ключ -> user.id, часть составного первичного ключа |
| group_id | Integer | Идентификатор группы | Внешний ключ -> group.id, часть составного первичного ключа |

## Связи между таблицами

### One-to-Many (один-ко-многим)

1. **User (role=teacher) -> Subject**
   - Один преподаватель может вести несколько предметов
   - Один предмет ведется одним преподавателем

2. **User (role=student) -> Attendance**
   - У одного студента может быть много записей о посещаемости
   - Каждая запись о посещаемости относится к одному студенту

3. **User (role=student) -> Grade**
   - У одного студента может быть много оценок
   - Каждая оценка относится к одному студенту

4. **Subject -> Schedule**
   - Один предмет может быть в расписании несколько раз
   - Каждая запись расписания относится к одному предмету

5. **Group -> Schedule**
   - У одной группы может быть много занятий в расписании
   - Каждая запись расписания относится к одной группе

6. **Subject -> Grade**
   - По одному предмету может быть выставлено много оценок
   - Каждая оценка относится к одному предмету

7. **Schedule -> Attendance**
   - На одно занятие по расписанию может быть много записей о посещаемости
   - Каждая запись о посещаемости относится к одному занятию по расписанию

### Many-to-Many (многие-ко-многим)

1. **User (role=student) <-> Group**
   - Один студент может состоять в нескольких группах
   - В одной группе может быть несколько студентов
   - Связь реализована через таблицу `student_group`

## Индексы и оптимизация

Для оптимизации работы базы данных созданы следующие индексы:

1. Первичные ключи автоматически индексируются во всех таблицах
2. Уникальные поля (`username`, `email` в таблице `user`, `name` в таблице `group`) также индексируются
3. Внешние ключи индексируются для ускорения поиска связанных записей

## Примеры запросов

### Получение списка студентов в группе

```python
students = db.session.query(User).join(student_group).join(Group).\
    filter(Group.id == group_id, User.role == 'student').all()
```

### Получение расписания для конкретной группы на день недели

```python
schedule = db.session.query(Schedule).\
    filter(Schedule.group_id == group_id, Schedule.day_of_week == day_number).\
    order_by(Schedule.start_time).all()
```

### Подсчет среднего балла студента по предмету

```python
avg_grade = db.session.query(db.func.avg(Grade.value)).\
    filter(Grade.student_id == student_id, Grade.subject_id == subject_id).scalar()
```

### Получение статистики посещаемости студента за период

```python
attendance_stats = db.session.query(
    Attendance.status, db.func.count(Attendance.id)
).filter(
    Attendance.student_id == student_id,
    Attendance.date.between(start_date, end_date)
).group_by(Attendance.status).all()
```

### Получение предметов, которые ведет преподаватель

```python
subjects = db.session.query(Subject).filter(Subject.teacher_id == teacher_id).all()
```
